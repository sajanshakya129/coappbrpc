# Protobuf RPC over CoAP protocol(UDP)

This library is developed to create a RPC that utilises features of CoAP protocol which uses UDP for transport. 
Protobuf is used as Interface Definition language(IDL). The goal is to use this RPC library over Constrained IoT devices.

## Getting Started
The following steps are written with the consideration that the system for development is fresh newly installed Linux Based System.

### Prerequisites
Please install following applications to build and install coappbrpc.
```bash
sudo apt-get install cmake build-essential dh-autoreconf python python-pip
```
#### Protocol buffer library Installation
Follow the following link and [install protobuf](https://github.com/protocolbuffers/protobuf/blob/master/src/README.md)
Or follow the following steps
```bash
sudo apt-get install libprotobuf-dev protobuf-compiler
```

#### LibCoAP version 2 Library Installation
```bash
git clone https://github.com/obgm/libcoap.git
cd libcoap

```
OPTIONAL:You might need to install pkg-config in your system if 'pkg-config' is not found.
```bash
sudo apt-get install pkg-config
```
Then configure libcoap and install libcoap
```bash
./autogen.sh
./configure --disable-doxygen --disable-manpages
make
sudo make install
sudo ldconfig /usr/local/lib
```

## Installation of CoAPPbrpc library
```bash
git clone --single-branch -b newbranch https://github.com/sajanshakya129/coappbrpc
mkdir build && cd build
cmake ..
make
sudo make install
```

## Running Example
Go to example/src folder and generate stub files required using following commands.
```bash
cd [Project Folder]/example/
coappbrpc.sh rpc_ping.proto
```
ClientStub.sh ClientStub.h are autogenerated.

### Compiling and Running using cmake
```bash
mkdir build && cd build && cmake ..
make
```
#### Running client
In example folder, bin folder is created with executable files i.e. client and server
```bash
./bin/client
```
#### Running Server
```bash
./bin/server
```
OR

### Compiling and Running Client from terminal manually
```bash
g++ -o client rpc_ping.pb.cc ClientStub.cc client.cpp -lcoappbrpc -lcoap-2 -lprotobuf -lpthread
./client
```
### Compiling and Running Server from terminal manually
```bash
g++ -o server rpc_ping.pb.cc server.cpp -lcoappbrpc -lcoap-2 -lprotobuf -lpthread
./server
```

## Documentation
Detailed explanation of functions and classes can be found in folder documentation. You can run web based documentation by running documentation/html/index.html file

## Creating Proto File
To create a service for RPC, you need to define the response and request schema along with defination of Service in protofile as shown below.
```c++
syntax = "proto3"; // Denotes that we are using Protocol buffers 3 for compiling

package coappbrpc.api; // Packaging codes under coappbrpc.api namespace

option cc_generic_services = true;// To use protocol buffers services

message PingRequest {  // User defined Request named "PingRequest" with parameter "msg". 
    string msg = 1; // For multiple parameters the numbering is done in increasing format 
    //which is non-repititive or cannot be duplicate.
}

message PingResponse {  // User defined Response named "PingResponse" with parameter "result". 
    string result = 1;
}

service PingService { //User defined Service named "PingService" 
    rpc Ping (PingRequest) returns (PingResponse); //User defined method named "Ping" which takes "PingRequest" as input 
    //and give "PingResponse" as output.
}
```

## Creating Client
```c++
#include <coappbrpc/RpcClient.h> // To Create client you must include this file: coappbrpc/RpcClient.h

#include "ClientStub.h" //including ClientStub.h generated when you run "coappbrpc.sh <protofile>" in command prompt.
#include "rpc_ping.pb.h" //including rpc_ping.pb.h generate when you run "coappbrpc.sh <protofile>" 
//in command prompt. <filename.proto> will generate "filename.pb.h" and "filename.pb.cc"

#include <string>

using ::coappbrpc::RpcClient;  //Must be included in code
using ::coappbrpc::api::PingRequest; //Must be included in code
using ::coappbrpc::api::PingResponse; //Must be included in code
using ::coappbrpc::api::PingService; //Must be included in code
using namespace std;

class PingClient { //Defining Client Class
public:
  string ping(const string &msg) { //Defining method ping where we use RPC call
    
    PingRequest request;
    request.set_msg(msg); //Setting user msg to request. 
    //Note: In set_msg, msg is the parameter that we defined in protofile request.

    PingResponse response;
    stub.Ping(request, &response); // This is where actual RPC call is done.
   //Note: Ping is the method that we defined in protofile.

    return response.result();
  }

private:
    ClientStub stub; //creating instance of Client Stub
};

int main(void) {
  GOOGLE_PROTOBUF_VERIFY_VERSION; //verifiying protocol buffers version
  RpcClient *client = RpcClient::getInstance(); //creating a client instance
  client->setServerAddr("localhost:5683"); //setting up Server address. Default is "localhost:5683". 
  										//Note: must be in format <server_address>:<port_no>
  std::string msg("Hello world"); //defining msg to be sent to Server.
  
  PingClient pclient;
  std::string reply = pclient.ping(msg);
  std::cout << "Ping received: " << reply << std::endl;
}

```

## Creating Server
```c++
#include <coappbrpc/RpcServer.h> //To create server you must include this file: coappbrpc/RpcServer.h
#include "rpc_ping.pb.h" //including rpc_ping.pb.h generate when you run "coappbrpc.sh <protofile>" in command prompt.
						//<filename.proto> will generate "filename.pb.h" and "filename.pb.cc"

using ::coappbrpc::RpcServer; //Must be included in code

namespace coappbrpc {
namespace api {

using ::google::protobuf::Closure; //Must be included in code
using ::google::protobuf::RpcController; //Must be included in code

class PingServiceImpl : public PingService { //User defined class name PingServiceImpl which inherits from PingService class.
public:
  PingServiceImpl(){};

  virtual void Ping(RpcController *controller, const PingRequest *request,
                    PingResponse *response, Closure *done) { 
    //Defining Function named "Ping" which is defined as method in protobuf file. This is where you do 
    //processing and generate result and set result. 
    
    // Do your processing here

    //Setting  result and accessing request parameter "msg".

    response->set_result("I got your message: " + request->msg()); 
  }
};

} // namespace api
} // namespace coappbrpc

int main() {
  RpcServer server; //Creating instance of server
  server.registerService(new ::coappbrpc::api::PingServiceImpl()); //Registering service
  server.runServer(); //running server
  // server.runServer("localhost:5683");// You can run server by providing server_address and port no.
  return 0;
}
```

## Uninstall library
To uninstall library and files related from your system. you need to execute following command.
```
sudo uninstall_coappbrpc.sh
```

## Authors

* **Sajan Shakya** - *Initial work* - [Github](https://github.com/sajanshakya129)

## References
This library was created referring to library [LibPbrpc](https://github.com/madwyn/libpbrpc) and gRPC.

## License
This project is licensed under the MIT License - see the [LICENSE.md](LICENSE.md) file for details
